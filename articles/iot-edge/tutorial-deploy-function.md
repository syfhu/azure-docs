---
title: Deploy Azure Function with Azure IoT Edge | Microsoft Docs 
description: Deploy Azure Function as a module to an edge device
author: kgremban
manager: timlt
ms.author: kgremban
ms.date: 06/26/2018
ms.topic: tutorial
ms.service: iot-edge
services: iot-edge
ms.custom: mvc
#Customer intent: As an IoT developer, I want to use Azure functions to execute logic on edge devices to filter data and communications that is sent to the cloud.
---

# Tutorial: Deploy Azure Functions as IoT Edge modules - preview

You can use Azure Functions to deploy code that implements your business logic directly to your IoT Edge devices. This tutorial walks you through creating and deploying an Azure Function that filters sensor data on the simulated IoT Edge device that you created in the Deploy Azure IoT Edge on a simulated device on [Windows][lnk-tutorial1-win] or [Linux][lnk-tutorial1-lin] tutorials. In this tutorial, you learn how to:     

> [!div class="checklist"]
> * Use Visual Studio Code to create an Azure Function
> * Use VS Code and Docker to create a Docker image and publish it to a container registry 
> * Deploy the module from the container registry to your IoT Edge device
> * View filtered data

>[!NOTE]
>Azure Function modules on Azure IoT Edge are in public [preview](https://azure.microsoft.com/support/legal/preview-supplemental-terms/). 

The Azure Function that you create in this tutorial filters the temperature data generated by your device and only sends messages upstream to Azure IoT Hub when the temperature is above a specified threshold. 

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

## Prerequisites

To test the Functions module that you build in this tutorial, you need an IoT Edge device. You can use the device that you configured in the [Linux](quickstart-linux.md) or [Windows](quickstart.md) quickstart.

Have the following prerequisites on your development machine: 
* [Visual Studio Code](https://code.visualstudio.com/). 
* [C# for Visual Studio Code (powered by OmniSharp) extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode.csharp) for Visual Studio Code.
* [Azure IoT Edge extension](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-edge) for Visual Studio Code. 
* [.NET Core 2.1 SDK](https://www.microsoft.com/net/download).
* [Docker CE](https://docs.docker.com/install/) on your development machine. 

## Create a container registry
In this tutorial, you use the Azure IoT Edge extension for VS Code to build a module and create a **container image** from the files. Then you push this image to a **registry** that stores and manages your images. Finally, you deploy your image from your registry to run on your IoT Edge device.  

You can use any Docker-compatible registry for this tutorial. Two popular Docker registry services available in the cloud are [Azure Container Registry](https://docs.microsoft.com/azure/container-registry/) and [Docker Hub](https://docs.docker.com/docker-hub/repos/#viewing-repository-tags). This tutorial uses Azure Container Registry. 

1. In the [Azure portal](https://portal.azure.com), select **Create a resource** > **Containers** > **Container Registry**.

    ![create container registry](./media/tutorial-deploy-function/create-container-registry.png)

2. Give your registry a name, and choose a subscription.
3. For the resource group, it is recommended that you use the same resource group name that contains your IoT Hub. By keeping all the resources together in the same group, you can manage them together. For example, deleting the resource group used for testing deletes all test resources contained in the group. 
4. Set the SKU to **Basic**, and toggle **Admin user** to **Enable**. 
5. Click **Create**.
6. Once your container registry is created, navigate to it and select **Access keys**. 
7. Copy the values for **Login server**, **Username**, and **Password**. You'll use these values later in the tutorial. 

## Create a function project
The following steps show you how to create an IoT Edge function using Visual Studio Code and the Azure IoT Edge extension.

1. Open Visual Studio Code.
2. Open the VS Code integrated terminal by selecting **View** > **Integrated Terminal**. 
2. Open the VS Code command palette by selecting **View** > **Command Palette**.
3. In the command palette, type and run the command **Azure: Sign in** and follow the instructions to sign in your Azure account. If you've already signed in, you can skip this step.
3. In the command palette, type and run the command **Azure IoT Edge: New IoT Edge solution**. In the command palette, provide the following information to create your solution: 

   1. Select the folder where you want to create the solution. 
   2. Provide a name for your solution or accept the default **EdgeSolution**.
   3. Choose **Azure Functions - C#** as the module template. 
   4. Name your module **CSharpFunction**. 
   5. Specify the Azure Container Registry that you created in the previous section as the image repository for your first module. Replace **localhost:5000** with the login server value that you copied. The final string looks like **\<registry name\>.azurecr.io/csharpfunction**.

4. The VS Code window loads your IoT Edge solution workspace. There is a **.vscode** folder, a **modules** folder, a deployment manifest template file and a **.env** file. Open **modules** > **CSharpFunction** > **EdgeHubTrigger-Csharp** > **run.csx**.

5. Replace the contents of the file with the following code:

   ```csharp
   #r "Microsoft.Azure.Devices.Client"
   #r "Newtonsoft.Json"

   using System.IO;
   using Microsoft.Azure.Devices.Client;
   using Newtonsoft.Json;

   // Filter messages based on the temperature value in the body of the message and the temperature threshold value.
   public static async Task Run(Message messageReceived, IAsyncCollector<Message> output, TraceWriter log)
   {
        const int temperatureThreshold = 25;
        byte[] messageBytes = messageReceived.GetBytes();
        var messageString = System.Text.Encoding.UTF8.GetString(messageBytes);

        if (!string.IsNullOrEmpty(messageString))
        {
            // Get the body of the message and deserialize it
            var messageBody = JsonConvert.DeserializeObject<MessageBody>(messageString);

            if (messageBody != null && messageBody.machine.temperature > temperatureThreshold)
            {
                // Send the message to the output as the temperature value is greater than the threashold
                var filteredMessage = new Message(messageBytes);
                // Copy the properties of the original message into the new Message object
                foreach (KeyValuePair<string, string> prop in messageReceived.Properties)
                {
                    filteredMessage.Properties.Add(prop.Key, prop.Value);                }
                // Add a new property to the message to indicate it is an alert
                filteredMessage.Properties.Add("MessageType", "Alert");
                // Send the message        
                await output.AddAsync(filteredMessage);
                log.Info("Received and transferred a message with temperature above the threshold");
            }
        }
    }

    //Define the expected schema for the body of incoming messages
    class MessageBody
    {
        public Machine machine {get; set;}
        public Ambient ambient {get; set;}
        public string timeCreated {get; set;}
    }
    class Machine
    {
       public double temperature {get; set;}
       public double pressure {get; set;}         
    }
    class Ambient
    {
       public double temperature {get; set;}
       public int humidity {get; set;}         
    }
   ```

6. Save the file.

## Build your IoT Edge solution

In the previous section you created an IoT Edge solution and added code to the CSharpFunction that will filter out messages where the reported machine temperature is below the acceptable threshold. Now you need to build the solution as a container image and push it to your container registry.

1. Sign in to Docker by entering the following command in the Visual Studio Code integrated terminal, so you can push your module image to the ACR: 
     
    ```csh/sh
    docker login -u <ACR username> <ACR login server>
    ```
    Use the username, and login server that you copied from your Azure Container Registry earlier. You will be prompted for the password. Paste your password into the prompt and press **Enter**.

    ```csh/sh
    Password: <paste in the ACR password and press enter>
    Login Succeeded
    ```

2. In the VS Code explorer, open the **deployment.template.json** file in your IoT Edge solution workspace. This file tells the IoT Edge runtime which modules to deploy to a device. To learn more about deployment manifests, see [Understand how IoT Edge modules can be used, configured, and reused](module-composition.md).

3. Find the **registryCredentials** section in the deployment manifest. Update the **username**, **password**, and **address** with the credentials from your container registry. This section gives the IoT Edge runtime on your device permission to pull the container images that you store in your private registry. The actual username and password pairs are stored in the .env file which is git ignored.

5. Save this file.

6. In the VS Code explorer, right-click the **deployment.template.json** file and select **Build IoT Edge solution**. 

When you tell Visual Studio Code to build your solution, it first takes the information in the deployment template and generates a `deployment.json` file in a new **config** folder. Then it runs two commands in the integrated terminal: `docker build` and `docker push`. These two commands build your code, containerize the functions, and the push it to the container registry that you specified when you initialized the solution. 

## View your container image

Visual Studio Code outputs a success message when your container image is pushed to your container registry. If you want to confirm the successful operation for yourself, you can view the image in the registry. 

1. In the Azure portal, navigate to your Azure container registry. 
2. Select **Repositories**.
3. You should see the **csharpfunction** listed in your repositories. Select the repository to see more details.
4. In the **Tags** section you should see **0.0.1-amd64**. This tag reflects the version and platform of the image that you built. These values are set in the **module.json** file in the CSharpFunction folder. 

## Deploy and run the solution

You could use the Azure portal to deploy your Functions module to an IoT Edge device like you did in the quickstarts, but you can also deploy and monitor modules from within Visual Studio Code. The following sections use the Azure IoT Edge extension for VS Code that was listed in the prerequisites. Install that now if you did not already. 

1. Open the VS Code command palette by selecting **View** > **Command Palette**.

2. Search for and run the command **Azure: Sign in**. Follow the instructions to sign in your Azure account. 

3. In the command palette, search for and run the command **Azure IoT Hub: Select IoT Hub**. 

4. Select the subscription that contains your IoT hub, then select the IoT hub that you want to access.

5. In the VS Code explorer, expand the **Azure IoT Hub Devices** section. 

6. Right-click the name of your IoT Edge device, then select **Create Deployment for IoT Edge device**. 

7. Navigate to the solution folder that contains CSharpFunction. Open the **config** folder and select the **deployment.json** file. Click **Select Edge Deployment Manifest**.

8. Refresh the **Azure IoT Hub Devices** section. You should see the new **CSharpFunction** running along with the **TempSensor** module and the **$edgeAgent** and **$edgeHub**. 

   ![View deployed modules in VS Code](./media/tutorial-deploy-function/view-modules.png)

## View generated data

You can see all the messages arriving at your IoT hub by running **Azure IoT Hub: Start Monitoring D2C Message** in the command palette.

You can also filter to see all the messages arriving at your IoT hub from a specific device. Right-click the device in the **Azure IoT Hub Devices** section and select **Start Monitoring D2C Messages**.

To stop monitoring messages, run the command **Azure IoT Hub: Stop monitoring D2C message** in the command palette. 


## Clean up resources

[!INCLUDE [iot-edge-quickstarts-clean-up-resources](../../includes/iot-edge-quickstarts-clean-up-resources.md)]

Remove the IoT Edge service runtime based on your IoT device platform (Linux or Windows).

#### Windows

Remove the IoT Edge runtime.

```Powershell
stop-service iotedge -NoWait
sleep 5
sc.exe delete iotedge
```

Delete the containers that were created on your device. 

```Powershell
docker rm -f $(docker ps -a --no-trunc --filter "name=edge" --filter "name=tempSensor" --filter "name=CSharpFunction")
```

#### Linux

Remove the IoT Edge runtime.

```bash
sudo apt-get remove --purge iotedge
```

Delete the containers that were created on your device. 

```bash
sudo docker rm -f $(sudo docker ps -a --no-trunc --filter "name=edge" --filter "name=tempSensor" --filter "name=CSharpFunction")
```

Remove the container runtime.

```bash
sudo apt-get remove --purge moby
```



## Next steps

In this tutorial, you created an Azure Functions module that contains code to filter raw data generated by your IoT Edge device. When you're ready to build your own modules, you can learn more about how to [Develop Azure Functions with Azure IoT Edge for Visual Studio Code](how-to-develop-csharp-function.md). 

Continue on to the next tutorials to learn about other ways that Azure IoT Edge can help you turn data into business insights at the edge.

> [!div class="nextstepaction"]
> [Find averages using a floating window in Azure Stream Analytics](tutorial-deploy-stream-analytics.md)

<!--Links-->
[lnk-tutorial1-win]: quickstart.md
[lnk-tutorial1-lin]: quickstart-linux.md
